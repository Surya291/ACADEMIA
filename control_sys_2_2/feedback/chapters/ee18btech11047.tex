For the circuit shown in Fig. \ref{fig:ee18btech11047_fig1}, find the loop gain $L(s) = G(s)H(s)$, $L\brak{\j\omega}$, the frequency for zero loop phase, and $R_{2}/R_{1}$ for oscillation.
\begin{enumerate}[label=\arabic*.,ref=\theenumi]
%\begin{enumerate}[label=\thesection.\arabic*.,ref=\thesection.\theenumi]
\numberwithin{equation}{enumi}

\item Draw the equivalent control system representation for the circuit in Fig. \ref{fig:ee18btech11047_fig1} as well as the small signal model. 
\\
\solution See Figs. \ref{fig:ee18btech11047_block}, \ref{fig:ee18btech11047_fig2} and \ref{fig:ee18btech11047_fig3}. Oscillators do not include input signal.
%
\renewcommand{\thefigure}{\theenumi.\arabic{figure}}
%
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_1.tex}}
	\end{center}
\caption{}
\label{fig:ee18btech11047_fig1}
\end{figure}
%
%\solution See Fig. \ref{fig:ee18btech11047_fig2}. 
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_block.tex}}
	\end{center}
\caption{Block diagram}
\label{fig:ee18btech11047_block}
\end{figure}
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_2.tex}}
	\end{center}
\caption{Simplified equivalent block diagram}
\label{fig:ee18btech11047_fig2}
\end{figure}
%
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_3.tex}}
	\end{center}
\caption{}
\label{fig:ee18btech11047_fig3}
\end{figure}
\renewcommand{\thefigure}{\theenumi}
%
\item Draw the block diagram and circuit diagram for $H$.\\
\solution See Figs. \ref{fig:ee18btech11047_fig4} and \ref{fig:ee18btech11047_fig5}. 
\numberwithin{figure}{enumi}
\renewcommand{\thefigure}{\theenumi.\arabic{figure}}
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_4.tex}}
	\end{center}
\caption{Feedback block diagram}
\label{fig:ee18btech11047_fig4}
\end{figure}
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_5.tex}}
	\end{center}
\caption{Feedback circuit}
\label{fig:ee18btech11047_fig5}
\end{figure}
\renewcommand{\thefigure}{\theenumi}
\item Find $H$.
\\
\solution In Fig. \ref{fig:ee18btech11047_fig5}, let $I_o$ be the current flowing from $V_o$.  Then
\begin{align}
\label{eq:ee18btech11047_H_io}
I_o = \frac{V_o}{\frac{1}{sC} + R \parallel \brak{R+\frac{1}{sC}}}
\end{align}
%
Using current division,
\begin{align}
\label{eq:ee18btech11047_H_vf}
V_f = I_o \frac{R}{R +  \brak{R+\frac{1}{sC}}} \times \frac{1}{sC}
%I_o = \frac{V_o}{\frac{1}{sC} + \brak{R \parallel \frac{1}{sC}}}
\end{align}
From \eqref{eq:ee18btech11047_H_io} and \eqref{eq:ee18btech11047_H_vf},


%the analysis is same as problem \ref{prob:ee18btech11047_H}
\begin{align}
%V_f = V_o \frac{\frac{1}{sC}}{\frac{1}{sC}+}
\frac{V_{f}}{V_{o}} &= \frac{R}{R +  \brak{R+\frac{1}{sC}}} \times \frac{1}{sC} 
\nonumber \\
&\quad \times \frac{1}{\frac{1}{sC} + R \parallel \brak{R+\frac{1}{sC}}}
\\
\implies H &= \frac{1}{\brak{3+sRC +\frac{1}{sRC}}}
\end{align}
%
after simplification.
\item Find $R_{11}$ and $R_{22}$ from Fig. \ref{fig:ee18btech11047_fig5}. 
\\
\solution Shorting  $V_{o}$ to ground,
\begin{align}
R_{11} &= \frac{1}{sC} \parallel \brak{R+ R\parallel\frac{1}{sC}} 
\label{eq:ee18btech11047_6}
\end{align}
Shorting $V_{f}$ to ground,
\begin{align}
R_{22} &= \frac{1}{sC} + \frac{R}{2}   
\end{align}
%
%----------------------------------------------------
\item Draw the block diagram and circuit diagram for $G$.\\
\solution See Figs. \ref{fig:ee18btech11047_fig6} and \ref{fig:ee18btech11047_fig7}.

\numberwithin{figure}{enumi}
\renewcommand{\thefigure}{\theenumi.\arabic{figure}}
%
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_6.tex}}
	\end{center}
\caption{Open loop block diagram}
\label{fig:ee18btech11047_fig6}
\end{figure}
%
\begin{figure}[!ht]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11047/ee18btech11047_7.tex}}
	\end{center}
\caption{Open loop circuit diagram}
\label{fig:ee18btech11047_fig7}
\end{figure}
\renewcommand{\thefigure}{\theenumi}
%
\item Find $G$.
\\
\solution 
From Fig.\ref{fig:ee18btech11047_fig7}
\begin{align}
V_{f_{2}} &= \brak{\frac{R_{1}}{R_{1} + R_{2}}}V_{o}
\end{align}
\begin{align}
G_{1} &= \frac{V_{f_{2}}}{V_{o}}
\end{align}
\begin{align}
\label{eq:ee18btech11047_G1}
\implies G_{1} &= \frac{R_{1}}{R_{1} + R_{2}}
\end{align}
From Fig. \ref{fig:ee18btech11047_block} ,$G_{1}$ is the negative feedback factor and $G_{o}$ is the gain of the op-amp.Therefore,equivalent $G$ is given by
\begin{align}
G &= \frac{G_{o}}{1+G_{o}G_{1}}
\end{align}
\begin{align}
G  &= \frac{1}{\frac{1}{G_{o}} + G_{1}}
\end{align}
We assumed $G_{0}\to\infty$. 
\begin{align}
\implies G&=\frac{1}{G_{1}}
\end{align}
From equation \eqref{eq:ee18btech11047_G1}.
\begin{align}
\implies G &= \frac{R_{1}+R_{2}}{R_{1}}=1+\frac{R_{2}}{R_{1}}
\end{align}
Hence verified with equation \eqref{eq:ee18btech11047_1}.
\item Find the feedback factor $H$. \\
\label{prob:ee18btech11047_H}
\solution The small signal model is shown in Fig. \ref{fig:ee18btech11047_fig3}
Applying KCL at node $V_f$
\begin{align}
\frac{V_{f} - 0}{\frac{1}{sC}} +\frac{V_{f} - V_{a}}{R} &= 0
\end{align}
\begin{align}
V_{f}\brak{sC+\frac{1}{R}} &= \frac{V_{a}}{R} 
\end{align}
\begin{align}
\label{eq:ee18btech11047_2}
V_{a} &= V_{f}\brak{sRC + 1} 
\end{align}
Applying KCL at node $V_{a}$
\begin{align}
\frac{V_{a} - V_{f}}{R} + \frac{V_{a} - 0}{R} + \frac{V_{a} - V_{o}}{\frac{1}{sC}} &= 0
\end{align}
\begin{align}
V_{a}\brak{\frac{2}{R} +sC} &= \frac{V_{f}}{R} + V_{o}sC
\end{align}
Substitute $V_{a}$ value from equation\eqref{eq:ee18btech11047_2}
\begin{align}
V_{f}(sRC + 1)\brak{\frac{2}{R} + sC} &= \frac{V_{f}}{R} + V_{o}sC
\end{align}
\begin{align}
V_{f}\brak{3 + sRC + \frac{1}{sRC}} &= V_{o}
\end{align}
The feedback factor H is given by 
\begin{align}
H &= \frac{V_{f}}{V_{o}}
\end{align}
\begin{align}
\label{eq:ee18btech11047_3}
\implies H &= \frac{1}{\brak{3+sRC +\frac{1}{sRC}}}
\end{align}
\item Find the open loop gain $G$.\\
\label{prob:ee18btech11047_G}
\solution Let the closed loop gain, open-loop gain of op-amp connected in non-inverting configuration be $T_{0}$ and $G_{0}$ respectively.
From Table \ref{table:ee18btech11005_Output_Table}
\begin{align}
T_{0} &= \frac{G_{0}\brak{R_1+R_2}}{\brak{R_1+R_2}+G_{0}R_1}
\end{align}
\begin{align}
T_{0} &= \frac{\brak{R_1+R_2}}{\brak{R_1+R_2}/G_{0}+R_1}
\end{align}
Assuming $G_{0}\to\infty$
\begin{align}
T_{0} &= 1 + \frac{R_{2}}{R_{1}}
\end{align}
The open loop gain of the circuit shown in Fig. \ref{fig:ee18btech11047_fig1} is equal to the closed loop gain of an op-amp connected in non-inverting configuration.
\begin{align}
G &= T_{0}
\end{align}
\begin{align}
\label{eq:ee18btech11047_1}
\implies G = 1 + \frac{R_{2}}{R_{1}}
\end{align}
%
%
\item Find the loop gain L(s).\\
\solution The transfer function of the equivalent positive feedback circuit in Fig. \ref{fig:ee18btech11047_fig2} is  
\begin{align}
T &= \frac{G}{1-GH}
\label{eq:ee18btech11047_TF}
\end{align}
Therefore, loop gain is given by 
\begin{align}
L &= GH
\end{align}
From equations \eqref{eq:ee18btech11047_1} and \eqref{eq:ee18btech11047_3}
\begin{align}
L(s) &= \brak{1 + \frac{R_{2}}{R_{1}}}\brak{\frac{1}{3+sRC+\frac{1}{sRC}}}
\end{align}
\begin{align}
\label{eq:ee18btech11047_4}
\implies L(s) &= \brak{\frac{1+\frac{R_{2}}{R_{1}}}{3+sRC+\frac{1}{sRC}}}
\end{align}
%
\item Find the loop gain in terms of $j\omega$ .\\
\solution Substitute $s = j\omega$ in equation \eqref{eq:ee18btech11047_4}
\begin{align} 
L\brak{\j\omega}&= \brak{\frac{1+\frac{R_{2}}{R_{1}}}{3+j\omega RC+\frac{1}{j\omega RC}}}
\end{align}
\begin{align}
\label{eq:ee18btech11047_5}
\implies L\brak{\j\omega}&= \brak{\frac{1+\frac{R_{2}}{R_{1}}}{3+ j \brak{\omega RC-\frac{1}{\omega RC}}}}
\end{align}
\item Find the frequency for zero loop phase.\\
\solution The frequency at which loop phase will be zero (i.e. loop gain will be a real number).To obtain the required frequency, equate the imaginary part of the loop gain $L(j \omega )$ to zero.
\begin{align}
j\brak{\omega RC - \frac{1}{\omega RC}} &= 0
\end{align}
\begin{align}
\omega^{2} &= \frac{1}{(RC)^{2}}
\end{align}
\begin{align}
\label{eq:ee18btech11047_freq}
\implies \omega &= \frac{1}{RC}
\end{align}
%
\item Find $R_{2}/R_{1}$ for oscillation.\\
\solution For oscillations to start, 
\begin{itemize}
    \item the imaginary part of the loop gain should become zero.
    \item the loop gain must be at least equal to unity.
\end{itemize}
From equation \eqref{eq:ee18btech11047_5} 
\begin{align}
\brak{\frac{1+\frac{R_{2}}{R_{1}}}{3+j(0)}} &\geq 1
\end{align}
\begin{align}
1+\frac{R_{2}}{R_{1}} &\geq 3
\end{align}
\begin{align}
\implies \frac{R_{2}}{R_{1}} &\geq 2
\end{align}
\item Find the amplitude and frequency for some arbitrary R,C values given in Table \ref{table:ee18btech110047_Input_Table}.\\
\begin{table}[!ht]
\centering
\input{./tables/ee18btech11047/ee18btech11047_table1.tex}
\caption{}
\label{table:ee18btech110047_Input_Table}
\end{table}
\solution From equation \eqref{eq:ee18btech11047_1} 
\begin{align}
G &= 1 + \frac{R_{2}}{R_{1}} = 3
\end{align}
From equation \eqref{eq:ee18btech11047_3}
\begin{align}
H &= \frac{1}{3 + 0.25s + \frac{1}{0.25s}}
\end{align}
From equation \eqref{eq:ee18btech11047_TF}
\begin{align}
T &= \frac{3\brak{0.0625s^{2} + 0.75s + 1}}{0.0625s^{2} + 1}
\end{align}
The following code plots the oscillating response of the system.
\begin{lstlisting}
codes/ee18btech11047/ee18btech11047.py
\end{lstlisting}
\begin{figure}[!ht]
\centering
\includegraphics[width=\columnwidth]{./figs/ee18btech11047/ee18btech11047.eps}
\caption{}
\label{fig:ee18btech11047_fig8}
\end{figure}
\textbf{Amplitude:}From Fig. \ref{fig:ee18btech11047_fig8} V(peak-peak) is 
\begin{align}
V_{p-p} &= 11.929-(-5.957)= 17.886
\end{align}
\begin{align}
V_{max} &= \frac{V_{p-p}}{2} = 8.943
\end{align}
\textbf{Frequency:} From equation \eqref{eq:ee18btech11047_freq}
\begin{align}
\omega = \frac{1}{RC} = 4 rad/sec
\end{align}
\begin{align}
f = \frac{\omega }{2\pi} = 0.636 Hz
\end{align}
\item Verify the amplitude and frequency using spice simulation.\\
\solution The following readme file provides necessary instructions to simulate the circuit in spice.
\begin{lstlisting}
codes/ee18btech11047/spice/README
\end{lstlisting}
The following netlist simulates the given circuit.
\begin{lstlisting}
codes/ee18btech11047/spice/ee18btech11047.net
\end{lstlisting}
The following code plots the output from the oscillator spice simulation which is shown in Fig. \ref{fig:ee18btech11047_spice}.
\begin{lstlisting}
codes/ee18btech11047/spice/ee18btech11047_spice.py
\end{lstlisting}
\renewcommand{\thefigure}{\theenumi.\arabic{figure}}
%
\begin{figure}[!ht]
\centering
\includegraphics[width=\columnwidth]{./figs/ee18btech11047/ee18btech11047_spice.eps}
\caption{}
\label{fig:ee18btech11047_spice}
\end{figure}
%
The following code plots a part of the spice output from which we can observe a clear sinusoidal output shown in Fig. \ref{fig:ee18btech11047_spice2}.
\begin{lstlisting}
codes/ee18btech11047/spice/ee18btech11047_spice2.py
\end{lstlisting}
\begin{figure}[!ht]
\centering
\includegraphics[width=\columnwidth]{./figs/ee18btech11047/ee18btech11047_spice2.eps}
\caption{}
\label{fig:ee18btech11047_spice2}
\end{figure}
\renewcommand{\thefigure}{\theenumi}
%
\textbf{Amplitude:}From Fig. \ref{fig:ee18btech11047_spice2} V(peak-peak) is 
\begin{align}
V_{p-p} &= 8.89-(-8.89)= 17.78
\end{align}
\begin{align}
V_{max} &= \frac{V_{p-p}}{2} = 8.89
\end{align}
\textbf{Frequency:} From Fig. \ref{fig:ee18btech11047_spice2} time period is calculated by any two end points of one cycle,
\begin{align}
T&=120.344-(-118.734) = 1.61 sec
\end{align}
\begin{align}
f = \frac{1}{T} = 0.621 Hz
\end{align}
Hence,the ampitude and frequency are verified through the spice simulation.
\end{enumerate}
